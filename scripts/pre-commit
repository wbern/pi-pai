#!/bin/bash
# Pre-commit hook for pi-pai
# Runs secrets detection before allowing commits

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# Check if gitleaks is installed
if ! command -v gitleaks &> /dev/null; then
    echo -e "${RED}Error: gitleaks is not installed${NC}"
    echo "Install with: brew install gitleaks"
    exit 1
fi

# Run gitleaks on staged changes
echo -e "${YELLOW}Scanning for secrets...${NC}"
if gitleaks protect --staged --config .gitleaks.toml --verbose; then
    echo -e "${GREEN}No secrets detected${NC}"
else
    echo -e "${RED}Secrets detected! Commit blocked.${NC}"
    echo "Review the findings above and remove any sensitive data."
    echo "If this is a false positive, update .gitleaks.toml allowlist."
    exit 1
fi

# Verify vault.yml is encrypted if it exists and is staged
VAULT_FILE="group_vars/all/vault.yml"
if git diff --cached --name-only | grep -q "$VAULT_FILE"; then
    echo -e "${YELLOW}Checking vault.yml encryption...${NC}"
    if head -1 "$VAULT_FILE" | grep -q '^\$ANSIBLE_VAULT'; then
        echo -e "${GREEN}vault.yml is encrypted${NC}"
    else
        echo -e "${RED}ERROR: vault.yml is NOT encrypted!${NC}"
        echo "Run: ansible-vault encrypt $VAULT_FILE"
        exit 1
    fi
fi

# Optional: Run ansible-lint if available
if command -v ansible-lint &> /dev/null; then
    echo -e "${YELLOW}Running ansible-lint...${NC}"
    if ansible-lint playbook.yml --quiet; then
        echo -e "${GREEN}Ansible lint passed${NC}"
    else
        echo -e "${YELLOW}Warning: ansible-lint found issues (non-blocking)${NC}"
    fi
fi

# Run ansible syntax check
if command -v ansible-playbook &> /dev/null; then
    echo -e "${YELLOW}Running syntax check...${NC}"
    if ansible-playbook playbook.yml --syntax-check > /dev/null 2>&1; then
        echo -e "${GREEN}Syntax check passed${NC}"
    else
        echo -e "${RED}Syntax check failed!${NC}"
        ansible-playbook playbook.yml --syntax-check
        exit 1
    fi
fi

echo -e "${GREEN}All pre-commit checks passed!${NC}"
