---
# Raspberry Pi Claude Server Deployment
# Run with: ansible-playbook playbook.yml --ask-vault-pass

- name: Deploy Claude Code server to Raspberry Pi
  hosts: pi
  gather_facts: true

  vars:
    # Override in group_vars/all/vars.yml
    pi_home: "/home/{{ pi_user }}"

  tasks:
    # =========================================================================
    # Variable Validation
    # =========================================================================
    - name: Validate required variables are set
      ansible.builtin.assert:
        that:
          - pi_host is defined and pi_host != "YOUR_PI_HOST"
          - pi_user is defined and pi_user | length > 0
          - repos_dir is defined
          - claude_docker_dir is defined
          - docker_image_name is defined
          - tmux_session_name is defined
        fail_msg: |
          Required variables are not configured!
          Please edit group_vars/all/vars.yml and set:
            - pi_host: Your Pi's hostname or IP (e.g., "claude-pi.local")
            - pi_user: Your Pi username
          See README.md for setup instructions.
        success_msg: "All required variables are configured"
      tags: [always]

    - name: Warn if using insecure default MCP bearer token
      ansible.builtin.debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════════╗
          ║  ⚠️  SECURITY WARNING: Using insecure default MCP bearer token!  ║
          ╠══════════════════════════════════════════════════════════════════╣
          ║  The MCP server is using the default 'tmux-local-dev' token.     ║
          ║  This is INSECURE for non-local deployments.                     ║
          ║                                                                  ║
          ║  To fix: Set vault_mcp_bearer_token in group_vars/all/vault.yml  ║
          ║  Generate a secure token: openssl rand -hex 32                   ║
          ╚══════════════════════════════════════════════════════════════════╝
      when: >-
        vault_mcp_bearer_token is not defined or
        vault_mcp_bearer_token == "" or
        mcp_bearer_token == "tmux-local-dev"
      tags: [always]

    # =========================================================================
    # OAuth Token Validation (local check)
    # =========================================================================
    - name: Check for Claude OAuth tokens locally
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/.tokens/.claude"
      delegate_to: localhost
      register: local_claude_tokens
      tags: [always, tokens]

    - name: Fail if Claude OAuth tokens not found
      ansible.builtin.fail:
        msg: |
          Claude OAuth tokens not found at .tokens/.claude/

          To fix this, authenticate locally first:
            1. make auth     # Run Claude/happy to complete OAuth
            2. make copy-tokens  # Copy tokens to .tokens/

          Then run deployment again.
      when: not local_claude_tokens.stat.exists
      tags: [always, tokens]

    - name: Check for Happy Coder tokens locally
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/.tokens/.happy"
      delegate_to: localhost
      register: local_happy_tokens
      tags: [always, tokens]

    # =========================================================================
    # Prerequisites
    # =========================================================================
    - name: Install system packages
      become: true
      ansible.builtin.apt:
        name:
          - tmux
          - git
          - curl
          - build-essential
          - unzip
          - htop
          - neovim
          - zram-tools
          - cpufrequtils
          - pipx
        state: present
        update_cache: true
      tags: [packages]

    - name: Set CPU governor to schedutil
      become: true
      ansible.builtin.copy:
        content: 'GOVERNOR="schedutil"'
        dest: /etc/default/cpufrequtils
        mode: '0644'
      tags: [performance]

    # =========================================================================
    # Optional Cleanup (saves ~200MB RAM)
    # =========================================================================
    - name: Check if snapd is installed
      ansible.builtin.command: dpkg -l snapd
      register: snapd_check
      changed_when: false
      failed_when: false
      tags: [cleanup, never]

    - name: Remove snapd (optional - saves memory)
      become: true
      ansible.builtin.apt:
        name: snapd
        state: absent
        purge: true
      when: snapd_check.rc == 0
      tags: [cleanup, never]

    - name: Remove snap directories
      become: true
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /snap
        - /var/snap
        - /var/lib/snapd
      when: snapd_check.rc == 0
      tags: [cleanup, never]

    # =========================================================================
    # Tailscale
    # =========================================================================
    - name: Check if Tailscale is installed
      ansible.builtin.command: tailscale --version
      register: tailscale_check
      changed_when: false
      failed_when: false
      tags: [tailscale]

    - name: Add Tailscale signing key
      become: true
      ansible.builtin.get_url:
        url: https://pkgs.tailscale.com/stable/ubuntu/{{ ansible_distribution_release }}.noarmor.gpg
        dest: /usr/share/keyrings/tailscale-archive-keyring.gpg
        mode: '0644'
      when: tailscale_check.rc != 0
      tags: [tailscale]

    - name: Add Tailscale apt repository
      become: true
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu {{ ansible_distribution_release }} main"
        filename: tailscale
        state: present
      when: tailscale_check.rc != 0
      tags: [tailscale]

    - name: Install Tailscale
      become: true
      ansible.builtin.apt:
        name: tailscale
        state: present
        update_cache: true
      when: tailscale_check.rc != 0
      tags: [tailscale]

    - name: Check Tailscale status
      ansible.builtin.command: tailscale status
      register: tailscale_status
      changed_when: false
      failed_when: false
      when: vault_tailscale_authkey is defined and vault_tailscale_authkey != ""
      tags: [tailscale]

    - name: Authenticate Tailscale
      become: true
      ansible.builtin.command: tailscale up --authkey={{ vault_tailscale_authkey }}
      when:
        - vault_tailscale_authkey is defined and vault_tailscale_authkey != ""
        - tailscale_status.rc != 0 or 'Logged out' in tailscale_status.stdout
      no_log: true
      diff: false
      tags: [tailscale]

    # =========================================================================
    # Docker
    # =========================================================================
    - name: Check if Docker is installed
      ansible.builtin.command: docker --version
      register: docker_check
      changed_when: false
      failed_when: false
      tags: [docker]

    - name: Install Docker prerequisites
      become: true
      ansible.builtin.apt:
        name:
          - ca-certificates
          - gnupg
        state: present
      when: docker_check.rc != 0
      tags: [docker]

    - name: Add Docker signing key
      become: true
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /usr/share/keyrings/docker-archive-keyring.asc
        mode: '0644'
      when: docker_check.rc != 0
      tags: [docker]

    - name: Add Docker apt repository
      become: true
      ansible.builtin.apt_repository:
        repo: "deb [arch={{ ansible_architecture | replace('x86_64', 'amd64') | replace('aarch64', 'arm64') }} signed-by=/usr/share/keyrings/docker-archive-keyring.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        filename: docker
        state: present
      when: docker_check.rc != 0
      tags: [docker]

    - name: Install Docker
      become: true
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
        update_cache: true
      when: docker_check.rc != 0
      tags: [docker]

    - name: Add user to docker group
      become: true
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: true
      tags: [docker]

    - name: Reset connection to pick up docker group
      ansible.builtin.meta: reset_connection
      tags: [docker]

    # =========================================================================
    # Node.js via nvm
    # =========================================================================
    - name: Check if nvm is installed
      ansible.builtin.stat:
        path: "{{ pi_home }}/.nvm/nvm.sh"
      register: nvm_check
      tags: [nodejs]

    - name: Install nvm
      ansible.builtin.shell: |
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
      when: not nvm_check.stat.exists
      tags: [nodejs]

    - name: Check if Node.js is installed
      ansible.builtin.shell: |
        source {{ pi_home }}/.nvm/nvm.sh
        node --version
      args:
        executable: /bin/bash
      register: node_check
      changed_when: false
      failed_when: false
      tags: [nodejs]

    - name: Install Node.js LTS via nvm
      ansible.builtin.shell: |
        source {{ pi_home }}/.nvm/nvm.sh
        nvm install --lts
      args:
        executable: /bin/bash
      when: node_check.rc != 0
      tags: [nodejs]

    - name: Check if pnpm is installed
      ansible.builtin.shell: |
        source {{ pi_home }}/.nvm/nvm.sh
        pnpm --version
      args:
        executable: /bin/bash
      register: pnpm_check
      changed_when: false
      failed_when: false
      tags: [nodejs]

    - name: Install pnpm via corepack
      ansible.builtin.shell: |
        source {{ pi_home }}/.nvm/nvm.sh
        corepack enable
        corepack prepare pnpm@latest --activate
      args:
        executable: /bin/bash
      when: pnpm_check.rc != 0
      tags: [nodejs]

    # =========================================================================
    # Directory Structure
    # =========================================================================
    - name: Create required directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ repos_dir }}"
        - "{{ claude_docker_dir }}"
        - "{{ claude_docker_dir }}/tmp"
        - "{{ claude_docker_dir }}/.ssh"
        - "{{ claude_docker_dir }}/.happy"
        - "{{ control_plane_dir }}/workspace"
        - "{{ mcp_server_dir }}"
        - "{{ github_mcp_dir }}"
        - "{{ pi_home }}/.config/github-mcp"
        - "{{ docker_image_dir }}"
        - "{{ pi_home }}/.config/systemd/user"
        - "{{ pi_home }}/.tmux/plugins"
      tags: [directories]

    # =========================================================================
    # Configuration Files
    # =========================================================================
    - name: Deploy tmux configuration
      ansible.builtin.copy:
        src: files/configs/tmux.conf
        dest: "{{ pi_home }}/.tmux.conf"
        mode: '0644'
      tags: [configs]

    - name: Deploy Claude settings.json
      ansible.builtin.copy:
        src: files/configs/settings.json
        dest: "{{ claude_docker_dir }}/settings.json"
        mode: '0644'
      tags: [configs]

    - name: Deploy SSH config for Docker
      ansible.builtin.copy:
        src: files/configs/ssh_config
        dest: "{{ claude_docker_dir }}/.ssh/config"
        mode: '0600'
      tags: [configs]

    - name: Set SSH directory permissions
      ansible.builtin.file:
        path: "{{ claude_docker_dir }}/.ssh"
        mode: '0700'
      tags: [configs]

    # =========================================================================
    # OAuth Tokens (from local .tokens/)
    # =========================================================================
    - name: Copy Claude OAuth tokens to Pi
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/.tokens/.claude/"
        dest: "{{ claude_docker_dir }}/"
        mode: preserve
      tags: [tokens]

    - name: Copy Happy Coder tokens to Pi
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/.tokens/.happy/"
        dest: "{{ claude_docker_dir }}/.happy/"
        mode: preserve
      when: local_happy_tokens.stat.exists
      tags: [tokens]

    - name: Report token deployment status
      ansible.builtin.debug:
        msg: |
          Claude tokens: deployed to {{ claude_docker_dir }}/
          Happy tokens: {{ 'deployed' if local_happy_tokens.stat.exists else 'not found (optional)' }}
      tags: [tokens]

    # =========================================================================
    # SSH Key for Git (Docker)
    # =========================================================================
    - name: Generate SSH key for Docker git access
      ansible.builtin.command:
        cmd: ssh-keygen -t ed25519 -C "claude-pi" -f {{ claude_docker_dir }}/.ssh/id_ed25519 -N ""
        creates: "{{ claude_docker_dir }}/.ssh/id_ed25519"
      tags: [ssh-key]

    - name: Read SSH public key
      ansible.builtin.slurp:
        src: "{{ claude_docker_dir }}/.ssh/id_ed25519.pub"
      register: ssh_pubkey
      tags: [ssh-key]

    - name: Add SSH key to GitHub
      ansible.builtin.uri:
        url: https://api.github.com/user/keys
        method: POST
        headers:
          Authorization: "Bearer {{ vault_github_pat }}"
          Accept: "application/vnd.github+json"
        body_format: json
        body:
          title: "claude-pi-{{ ansible_date_time.date }}"
          key: "{{ ssh_pubkey.content | b64decode | trim }}"
        status_code: [201, 422]  # 422 = key already exists
      when: >-
        vault_github_pat is defined and
        vault_github_pat | length > 10 and
        vault_github_pat != 'ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
      tags: [ssh-key]

    # =========================================================================
    # Scripts
    # =========================================================================
    - name: Deploy static scripts
      ansible.builtin.copy:
        src: "files/scripts/{{ item }}"
        dest: "{{ pi_home }}/{{ item }}"
        mode: '0755'
      loop:
        - upgrade-claude.sh
        - claude-sandbox-shell.sh
      tags: [scripts]

    - name: Deploy templated scripts
      ansible.builtin.template:
        src: "templates/{{ item }}.j2"
        dest: "{{ pi_home }}/{{ item }}"
        mode: '0755'
      loop:
        - claude-sandbox.sh
        - claude-attach.sh
      notify: Restart claude-tmux
      tags: [scripts]

    # =========================================================================
    # Documentation (CLAUDE.md files)
    # =========================================================================
    - name: Deploy Repos CLAUDE.md
      ansible.builtin.copy:
        src: files/docs/CLAUDE-repos.md
        dest: "{{ repos_dir }}/CLAUDE.md"
        mode: '0644'
      tags: [docs]

    - name: Deploy control plane CLAUDE.md
      ansible.builtin.copy:
        src: files/docs/CLAUDE-control-plane.md
        dest: "{{ control_plane_dir }}/workspace/CLAUDE.md"
        mode: '0644'
      tags: [docs]

    - name: Deploy helper CLAUDE.md
      ansible.builtin.copy:
        src: files/docs/CLAUDE-helper.md
        dest: "{{ pi_home }}/CLAUDE.md"
        mode: '0644'
      tags: [docs]

    # =========================================================================
    # Docker Image
    # =========================================================================
    - name: Deploy Dockerfile
      ansible.builtin.template:
        src: templates/Dockerfile.j2
        dest: "{{ docker_image_dir }}/Dockerfile"
        mode: '0644'
      notify: Build Docker image
      tags: [docker]

    - name: Check if Docker image exists
      ansible.builtin.command: docker images -q {{ docker_image_name }}
      register: docker_image_check
      changed_when: false
      failed_when: false
      tags: [docker]

    - name: Build Docker image if missing
      ansible.builtin.command:
        cmd: docker build -t {{ docker_image_name }} .
        chdir: "{{ docker_image_dir }}"
      when: docker_image_check.stdout == ""
      tags: [docker]

    # =========================================================================
    # MCP Server
    # =========================================================================
    - name: Deploy MCP server static files
      ansible.builtin.copy:
        src: "files/mcp-server/{{ item }}"
        dest: "{{ mcp_server_dir }}/{{ item }}"
        mode: "{{ '0755' if item == 'start.sh' else '0644' }}"
      loop:
        - package.json
        - start.sh
        - lib.js
      notify: Restart tmux-control-plane
      tags: [mcp]

    - name: Deploy MCP server.js from template
      ansible.builtin.template:
        src: templates/server.js.j2
        dest: "{{ mcp_server_dir }}/server.js"
        mode: '0644'
      notify: Restart tmux-control-plane
      tags: [mcp]

    - name: Check if MCP server dependencies installed
      ansible.builtin.stat:
        path: "{{ mcp_server_dir }}/node_modules"
      register: mcp_node_modules
      tags: [mcp]

    - name: Install MCP server dependencies
      ansible.builtin.shell: |
        source {{ pi_home }}/.nvm/nvm.sh
        cd {{ mcp_server_dir }}
        pnpm install
      args:
        executable: /bin/bash
      when: not mcp_node_modules.stat.exists
      tags: [mcp]

    - name: Deploy control plane MCP config
      ansible.builtin.template:
        src: templates/mcp.json.j2
        dest: "{{ control_plane_dir }}/workspace/.mcp.json"
        mode: '0644'
      notify: Restart claude-tmux
      tags: [mcp]

    - name: Deploy project session MCP config
      ansible.builtin.template:
        src: templates/mcp.json.j2
        dest: "{{ claude_docker_dir }}/.mcp.json"
        mode: '0644'
      tags: [mcp, configs]

    # =========================================================================
    # GitHub MCP Server (via mcp-proxy)
    # =========================================================================
    - name: Install mcp-proxy via pipx
      ansible.builtin.command:
        cmd: pipx install mcp-proxy
        creates: "{{ pi_home }}/.local/bin/mcp-proxy"
      when: >-
        vault_github_pat is defined and
        vault_github_pat | length > 10 and
        vault_github_pat != 'ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
      tags: [github-mcp]

    - name: Deploy GitHub MCP start script
      ansible.builtin.copy:
        src: files/github-mcp/start.sh
        dest: "{{ github_mcp_dir }}/start.sh"
        mode: '0755'
      when: >-
        vault_github_pat is defined and
        vault_github_pat | length > 10 and
        vault_github_pat != 'ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
      notify: Restart github-mcp
      tags: [github-mcp]

    - name: Pull GitHub MCP Docker image
      ansible.builtin.command: docker pull ghcr.io/github/github-mcp-server:{{ github_mcp_image_version }}
      register: docker_pull
      changed_when: "'Downloaded newer image' in docker_pull.stdout or 'Pull complete' in docker_pull.stdout"
      when: >-
        vault_github_pat is defined and
        vault_github_pat | length > 10 and
        vault_github_pat != 'ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
      tags: [github-mcp]

    - name: Deploy GitHub MCP environment file
      ansible.builtin.copy:
        content: |
          GITHUB_PERSONAL_ACCESS_TOKEN={{ vault_github_pat }}
          GITHUB_MCP_PORT={{ github_mcp_port }}
          GITHUB_MCP_IMAGE_VERSION={{ github_mcp_image_version }}
        dest: "{{ pi_home }}/.config/github-mcp/env"
        mode: '0600'
      when: >-
        vault_github_pat is defined and
        vault_github_pat | length > 10 and
        vault_github_pat != 'ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
      no_log: true
      diff: false
      notify: Restart github-mcp
      tags: [github-mcp, secrets]

    # =========================================================================
    # Secrets (from vault)
    # =========================================================================
    - name: Store GitHub PAT
      ansible.builtin.copy:
        content: "{{ vault_github_pat }}"
        dest: "{{ claude_docker_dir }}/.github_token"
        mode: '0600'
      when: >-
        vault_github_pat is defined and
        vault_github_pat | length > 10 and
        vault_github_pat != 'ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
      no_log: true
      diff: false
      tags: [secrets]

    - name: Store Context7 token
      ansible.builtin.copy:
        content: "{{ vault_context7_token }}"
        dest: "{{ claude_docker_dir }}/.context7_token"
        mode: '0600'
      when: vault_context7_token is defined and vault_context7_token != ""
      no_log: true
      diff: false
      tags: [secrets]

    - name: Store Claude OAuth token (1-year token from claude setup-token)
      ansible.builtin.copy:
        content: "{{ vault_claude_oauth_token }}"
        dest: "{{ claude_docker_dir }}/.oauth_token"
        mode: '0600'
      when: vault_claude_oauth_token is defined and vault_claude_oauth_token != ""
      no_log: true
      diff: false
      tags: [secrets]

    # =========================================================================
    # Systemd Services
    # =========================================================================
    - name: Enable user lingering
      become: true
      ansible.builtin.command: loginctl enable-linger {{ ansible_user }}
      changed_when: false
      tags: [systemd]

    - name: Deploy static systemd services
      ansible.builtin.copy:
        src: "files/systemd/{{ item }}"
        dest: "{{ pi_home }}/.config/systemd/user/{{ item }}"
        mode: '0644'
      loop:
        - tmux-control-plane.service
      notify:
        - Reload systemd
        - Restart tmux-control-plane
      tags: [systemd]

    - name: Deploy templated systemd services
      ansible.builtin.template:
        src: "templates/{{ item }}.j2"
        dest: "{{ pi_home }}/.config/systemd/user/{{ item }}"
        mode: '0644'
      loop:
        - claude-tmux.service
      notify:
        - Reload systemd
        - Restart claude-tmux
      tags: [systemd]

    - name: Deploy GitHub MCP systemd service
      ansible.builtin.template:
        src: templates/github-mcp.service.j2
        dest: "{{ pi_home }}/.config/systemd/user/github-mcp.service"
        mode: '0644'
      when: >-
        vault_github_pat is defined and
        vault_github_pat | length > 10 and
        vault_github_pat != 'ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
      notify:
        - Reload systemd
        - Restart github-mcp
      tags: [systemd, github-mcp]

    - name: Enable and start services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        state: started
        scope: user
        daemon_reload: true
      loop:
        - tmux-control-plane
        - claude-tmux
      tags: [systemd]

    - name: Enable and start GitHub MCP service
      ansible.builtin.systemd:
        name: github-mcp
        enabled: true
        state: started
        scope: user
        daemon_reload: true
      when: >-
        vault_github_pat is defined and
        vault_github_pat | length > 10 and
        vault_github_pat != 'ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
      tags: [systemd, github-mcp]

    # =========================================================================
    # tmux Plugins
    # =========================================================================
    - name: Clone TPM (tmux plugin manager)
      ansible.builtin.git:
        repo: https://github.com/tmux-plugins/tpm
        dest: "{{ pi_home }}/.tmux/plugins/tpm"
        depth: 1
      tags: [tmux]

    # =========================================================================
    # Shell Greeting
    # =========================================================================
    - name: Check if greeting already in bashrc
      ansible.builtin.command: grep -q "Claude Code Server" {{ pi_home }}/.bashrc
      register: greeting_check
      changed_when: false
      failed_when: false
      tags: [shell]

    - name: Add login greeting to bashrc
      ansible.builtin.blockinfile:
        path: "{{ pi_home }}/.bashrc"
        marker: "# {mark} ANSIBLE MANAGED - Claude greeting"
        block: "{{ lookup('template', 'templates/bashrc_greeting.j2') }}"
      when: greeting_check.rc != 0
      tags: [shell]

    # =========================================================================
    # Host-level Claude Code (optional)
    # =========================================================================
    - name: Install Claude Code on host
      ansible.builtin.shell: |
        source {{ pi_home }}/.nvm/nvm.sh
        npm install -g @anthropic-ai/claude-code
      args:
        executable: /bin/bash
      tags: [host-claude]

    - name: Check if telemetry disable in bashrc
      ansible.builtin.command: grep -q "CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC" {{ pi_home }}/.bashrc
      register: telemetry_check
      changed_when: false
      failed_when: false
      tags: [host-claude]

    - name: Disable telemetry in bashrc
      ansible.builtin.lineinfile:
        path: "{{ pi_home }}/.bashrc"
        line: 'export CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1'
      when: telemetry_check.rc != 0
      tags: [host-claude]

  handlers:
    - name: Build Docker image
      ansible.builtin.command:
        cmd: docker build -t {{ docker_image_name }} .
        chdir: "{{ docker_image_dir }}"
      register: docker_build
      changed_when: "'Successfully built' in docker_build.stdout or 'Successfully tagged' in docker_build.stdout"

    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true
        scope: user

    - name: Restart tmux-control-plane
      ansible.builtin.systemd:
        name: tmux-control-plane
        state: restarted
        scope: user

    - name: Restart claude-tmux
      ansible.builtin.systemd:
        name: claude-tmux
        state: restarted
        scope: user

    - name: Restart github-mcp
      ansible.builtin.systemd:
        name: github-mcp
        state: restarted
        scope: user
      when: >-
        vault_github_pat is defined and
        vault_github_pat | length > 10 and
        vault_github_pat != 'ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
